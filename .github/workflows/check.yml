name: APK Check

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'

permissions:
  contents: write

jobs:
  check-updates:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # برای دریافت کامل تاریخچه Git

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install aiohttp beautifulsoup4

      - name: Run main script
        run: python main.py

      - name: Commit and Push changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

          # بررسی وجود فایل‌ها و اضافه کردن آنها
          files_to_add=("packages.json" "progress.json" "updated_packages.html")
          any_file_added=false

          for file in "${files_to_add[@]}"; do
            if [ -f "$file" ]; then
              git add "$file"
              any_file_added=true
            fi
          done

          # فقط اگر فایلی اضافه شده بود commit کن
          if [ "$any_file_added" = true ]; then
            git commit -m "Update package versions [skip ci]"
            
            # دریافت آخرین تغییرات از ریموت با استراتژی rebase
            git pull --rebase origin main
            
            # انجام push
            git push origin main
          else
            echo "No files to commit."
          fi
